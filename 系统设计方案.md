● 系统设计方案

  1. 系统架构概览

  ┌─────────────────────────────────────────────────────────┐
  │                    监控分析系统                          │
  ├─────────────────────────────────────────────────────────┤
  │                                                           │
  │  ┌──────────┐    ┌──────────┐    ┌──────────┐          │
  │  │日志监听器 │ -> │错误检测器 │ -> │Claude调用 │          │
  │  │LogMonitor│    │ErrorDetector│   │ClaudeClient│          │
  │  └──────────┘    └──────────┘    └──────────┘          │
  │       │                │                │               │
  │       v                v                v               │
  │  ┌──────────┐    ┌──────────┐    ┌──────────┐          │
  │  │文件变更  │    │错误模式  │    │结果解析器 │          │
  │  │监控      │    │识别      │    │ResponseParser│         │
  │  └──────────┘    └──────────┘    └──────────┘          │
  │                                            │            │
  │                                            v            │
  │                                    ┌──────────┐        │
  │                                    │邮件发送器 │        │
  │                                    │EmailSender│        │
  │                                    └──────────┘        │
  │                                                           │
  └─────────────────────────────────────────────────────────┘

  2. 核心模块设计

● 2.1 日志监听器 (LogMonitor)

  职责: 监控指定的日志文件或目录，检测文件变化

  核心功能:
  - 支持监控单个文件或整个目录
  - 使用 watchdog 库实现文件系统事件监听
  - 检测文件新增、修改事件
  - 支持日志轮转检测
  - 防抖动处理（避免短时间内重复触发）

  关键方法:
  class LogMonitor:
      - start_watching()  # 启动监控
      - stop_watching()   # 停止监控
      - add_watch(path)   # 添加监控路径
      - on_file_changed(callback)  # 文件变更回调

  2.2 错误检测器 (ErrorDetector)

  职责: 从日志内容中识别并提取错误信息

  核心功能:
  - 多语言错误模式识别（Python, Java, JavaScript, Go等）
  - 支持正则表达式匹配规则
  - 错误上下文提取（错误前N行和后M行）
  - 堆栈跟踪识别
  - 去重处理（相同错误不重复处理）

  关键方法:
  class ErrorDetector:
      - detect_errors(log_content)  # 检测错误
      - extract_context(error, lines)  # 提取上下文
      - is_duplicate(error)  # 去重判断
      - load_patterns(config)  # 加载错误模式

  2.3 Claude客户端 (ClaudeClient)

  职责: 调用Claude Code API进行错误分析

  核心功能:
  - 通过 Anthropic API 调用 Claude
  - 构建结构化prompt
  - 处理API限流和重试
  - 支持流式和非流式响应
  - Token使用统计

  关键方法:
  class ClaudeClient:
      - analyze_error(error_info, context)  # 分析错误
      - build_prompt(error, code_snippet)   # 构建prompt
      - call_api(messages)                  # 调用API
      - handle_rate_limit()                 # 处理限流

  2.4 结果解析器 (ResponseParser)

  职责: 解析Claude返回的分析结果

  核心功能:
  - 提取解决方案和代码建议
  - 格式化为可读的邮件内容
  - 生成HTML邮件模板
  - 提取关键信息（错误原因、修复步骤等）

  关键方法:
  class ResponseParser:
      - parse_response(clude_response)  # 解析响应
      - extract_solution(content)       # 提取解决方案
      - format_email(parsed_data)       # 格式化邮件
      - generate_html(summary, solution) # 生成HTML

  2.5 邮件发送器 (EmailSender)

  职责: 将分析结果通过邮件发送给用户

  核心功能:
  - 支持SMTP协议
  - HTML格式邮件
  - 附件支持（日志文件）
  - 发送队列和重试机制
  - 发送记录日志

  关键方法:
  class EmailSender:
      - send_email(to, subject, content)  # 发送邮件
      - send_with_attachments(to, files)  # 带附件发送
      - create_queue()                    # 创建发送队列
      - retry_failed()                    # 重试失败邮件

  3. 数据流设计

● 3.1 主流程

  1. LogMonitor 监听日志文件
     ↓
  2. 检测到文件变更 → 读取新增内容
     ↓
  3. ErrorDetector 分析内容 → 识别错误
     ↓
  4. 如果是错误:
     ↓
  5. ClaudeClient 构建prompt → 调用API分析
     ↓
  6. ResponseParser 解析响应 → 提取解决方案
     ↓
  7. EmailSender 发送邮件到配置的收件人
     ↓
  8. 记录处理日志

  3.2 错误处理机制

  错误分类:
  - 系统错误: 监控失败、API调用失败 → 记录日志 + 本地告警
  - 业务错误: 未识别到错误、无有效响应 → 跳过处理
  - 网络错误: API超时、邮件发送失败 → 重试机制

  重试策略:
  - API调用: 指数退避重试（1s, 2s, 4s, 8s）
  - 邮件发送: 最多重试3次，间隔5分钟
  - 失败记录: 记录到失败队列，支持手动重试

  降级策略:
  - API限流: 延迟处理，进入队列等待
  - 邮件服务不可用: 保存结果到本地，等待恢复
  - Claude API不可用: 发送原始错误信息到邮件

  4. 技术栈和依赖

● 4.1 核心依赖

  # requirements.txt
  # 文件系统监控
  watchdog==4.0.0

  # Claude API
  anthropic==0.18.0

  # 邮件发送
  smtp-email (或使用Python标准库 smtplib+email)

  # 配置管理
  pyyaml==6.0.1
  python-dotenv==1.0.0

  # 日志
  loguru==0.7.2

  # 异步处理
  asyncio (Python标准库)
  aiohttp==3.9.0  # 可选，用于异步HTTP请求

  # 数据处理
  jinja2==3.1.3  # 邮件模板渲染

  # 调度和队列
  celery==5.3.0  # 可选，用于分布式任务队列
  redis==5.0.1   # 可选，用于消息队列

  4.2 项目目录结构

  ai-ops/
  ├── config/
  │   ├── config.yaml           # 主配置文件
  │   ├── error_patterns.yaml   # 错误模式配置
  │   └── email_template.html   # 邮件模板
  ├── src/
  │   ├── __init__.py
  │   ├── main.py               # 程序入口
  │   ├── monitors/
  │   │   ├── __init__.py
  │   │   └── log_monitor.py    # 日志监控器
  │   ├── detectors/
  │   │   ├── __init__.py
  │   │   └── error_detector.py # 错误检测器
  │   ├── clients/
  │   │   ├── __init__.py
  │   │   └── claude_client.py  # Claude客户端
  │   ├── parsers/
  │   │   ├── __init__.py
  │   │   └── response_parser.py # 响应解析器
  │   ├── notifiers/
  │   │   ├── __init__.py
  │   │   └── email_sender.py   # 邮件发送器
  │   ├── models/
  │   │   ├── __init__.py
  │   │   └── error_info.py     # 数据模型
  │   └── utils/
  │       ├── __init__.py
  │       ├── logger.py         # 日志工具
  │       └── config_loader.py  # 配置加载
  ├── logs/
  │   ├── app.log              # 应用日志
  │   └── errors/              # 错误记录
  ├── tests/
  │   ├── test_log_monitor.py
  │   ├── test_error_detector.py
  │   └── test_claude_client.py
  ├── .env.example             # 环境变量示例
  ├── requirements.txt
  └── README.md

  5. 配置文件设计

  5.1 config.yaml

  # 监控配置
  monitor:
    watch_paths:
      - "/var/log/app/*.log"
      - "./logs/*.log"
    recursive: true
    debounce_seconds: 2  # 防抖动时间

  # 错误检测配置
  error_detection:
    patterns_file: "config/error_patterns.yaml"
    context_lines:
      before: 10  # 错误前10行
      after: 5    # 错误后5行
    dedup_window_minutes: 60  # 去重时间窗口

  # Claude API配置
  claude:
    api_key_env: "ANTHROPIC_API_KEY"
    model: "claude-3-5-sonnet-20241022"
    max_tokens: 4096
    temperature: 0.3
    timeout: 60
    max_retries: 3

  # 邮件配置
  email:
    smtp_host: "smtp.gmail.com"
    smtp_port: 587
    username_env: "EMAIL_USERNAME"
    password_env: "EMAIL_PASSWORD"
    from_address: "ai-error-monitor@example.com"
    to_addresses:
      - "user@example.com"
    use_tls: true

  # 系统配置
  system:
    log_level: "INFO"
    log_file: "logs/app.log"
    max_concurrent_analysis: 3  # 最大并发分析数

  5.2 error_patterns.yaml

  # Python错误模式
  python:
    - regex: "Traceback \\(most recent call last\\):"
      name: "Python Exception"
      severity: "high"
    - regex: "\\[ERROR\\].*"
      name: "Python Error Log"
      severity: "medium"

  # Java错误模式
  java:
    - regex: "Exception in thread.*"
      name: "Java Exception"
      severity: "high"
    - regex: "ERROR.*"
      name: "Java Error"
      severity: "medium"

  # JavaScript/Node.js错误模式
  javascript:
    - regex: "Error:.*"
      name: "JavaScript Error"
      severity: "high"
    - regex: "Uncaught.*"
      name: "Uncaught Exception"
      severity: "high"

  # Go错误模式
  go:
    - regex: "panic:.*"
      name: "Go Panic"
      severity: "high"
    - regex: "ERROR\\].*"
      name: "Go Error"
      severity: "medium"

  6. 核心代码示例

  6.1 主程序入口 (main.py)

  import asyncio
  from src.monitors.log_monitor import LogMonitor
  from src.detectors.error_detector import ErrorDetector
  from src.clients.claude_client import ClaudeClient
  from src.parsers.response_parser import ResponseParser
  from src.notifiers.email_sender import EmailSender
  from src.utils.config_loader import ConfigLoader
  from src.utils.logger import setup_logger

  class ErrorAnalysisSystem:
      def __init__(self, config_path='config/config.yaml'):
          self.config = ConfigLoader.load(config_path)
          self.logger = setup_logger(self.config)

          # 初始化组件
          self.monitor = LogMonitor(self.config.monitor)
          self.detector = ErrorDetector(self.config.error_detection)
          self.claude = ClaudeClient(self.config.claude)
          self.parser = ResponseParser()
          self.email = EmailSender(self.config.email)

          # 设置回调
          self.monitor.on_file_changed(self._process_file_change)

      async def _process_file_change(self, file_path):
          """处理文件变更事件"""
          try:
              # 读取新增内容
              new_content = self.monitor.read_new_content(file_path)

              # 检测错误
              errors = self.detector.detect_errors(new_content)

              if not errors:
                  return

              for error in errors:
                  if self.detector.is_duplicate(error):
                      self.logger.info(f"Duplicate error, skipping: {error.signature}")
                      continue

                  # 分析错误
                  analysis = await self.claude.analyze_error(
                      error=error.content,
                      context=error.context,
                      file_path=file_path
                  )

                  # 解析结果
                  parsed = self.parser.parse_response(analysis)

                  # 发送邮件
                  await self.email.send_analysis(
                      to=self.config.email.to_addresses,
                      subject=f"错误分析报告: {parsed.title}",
                      content=parsed
                  )

                  self.logger.info(f"Successfully processed error from {file_path}")

          except Exception as e:
              self.logger.error(f"Error processing file {file_path}: {str(e)}")

      def start(self):
          """启动系统"""
          self.logger.info("Starting Error Analysis System...")
          self.monitor.start()

      def stop(self):
          """停止系统"""
          self.logger.info("Stopping Error Analysis System...")
          self.monitor.stop()

  if __name__ == "__main__":
      system = ErrorAnalysisSystem()
      try:
          system.start()
      except KeyboardInterrupt:
          system.stop()

  6.2 Claude Prompt模板

  ERROR_ANALYSIS_PROMPT = """你是一个专业的错误分析专家。请分析以下错误信息并提供解决方案。

  **错误信息:**
  {error_content}

  **上下文代码:**
  {context_code}

  **文件路径:** {file_path}

  请提供:
  1. 错误原因分析
  2. 详细的修复步骤
  3. 相关代码示例（如果适用）
  4. 预防建议

  请使用清晰的格式回复，方便在邮件中展示。
  """

  7. 高级特性（可选）

● 7.1 Web管理界面（v2版本）

  - Flask/FastAPI实现REST API
  - Vue.js前端界面
  - 功能：查看历史记录、配置管理、手动触发分析

  7.2 分布式处理

  - 使用Celery实现任务队列
  - Redis作为消息代理
  - 支持多节点部署

  7.3 智能去重

  - 基于错误签名的去重
  - 相似错误聚合
  - 错误趋势分析

  7.4 多渠道通知

  - 支持Slack、钉钉、企业微信
  - 短信通知（紧急错误）
  - Webhook集成

  8. 部署建议

  8.1 开发环境

  # 安装依赖
  pip install -r requirements.txt

  # 配置环境变量
  cp .env.example .env
  # 编辑.env文件，填入API密钥和邮箱配置

  # 运行
  python src/main.py

  8.2 生产环境

  # 使用systemd服务
  [Unit]
  Description=AI Error Analysis System
  After=network.target

  [Service]
  Type=simple
  User=app
  WorkingDirectory=/opt/ai-ops
  ExecStart=/usr/bin/python3 /opt/ai-ops/src/main.py
  Restart=always

  [Install]
  WantedBy=multi-user.target

  8.3 Docker部署

  FROM python:3.11-slim

  WORKDIR /app
  COPY requirements.txt .
  RUN pip install -r requirements.txt

  COPY . .
  CMD ["python", "src/main.py"]

  9. 监控和维护

  9.1 健康检查

  - 定期检查API连接状态
  - 邮件发送队列监控
  - 磁盘空间监控（日志文件）

  9.2 性能优化

  - 异步处理提高吞吐量
  - 限制并发API调用数
  - 缓存常见错误的分析结果

  9.3 安全考虑

  - API密钥加密存储
  - 邮件密码使用环境变量
  - 日志文件访问权限控制
  - 限制日志文件大小（防止内存溢出）

  10. 下一步行动

● 设计方案总结

  我已经完成了完整的系统设计方案，这是一个自动化的错误监控和分析系统。主要特点：

  核心功能

  1. 日志监控: 自动监听日志文件变化
  2. 智能检测: 识别多种编程语言的错误模式
  3. AI分析: 调用Claude API进行错误分析
  4. 自动通知: 将分析结果通过邮件发送

  技术亮点

  - 模块化设计，易于扩展
  - 完善的错误处理和重试机制
  - 支持多种错误类型（Python、Java、JavaScript、Go等）
  - 配置驱动，无需修改代码即可调整
  - 异步处理，性能优化

  关键优势

  - 零人工干预: 全自动处理流程
  - 快速响应: 实时监控+自动分析
  - 智能去重: 避免重复分析相同错误
  - 可扩展性: 支持未来添加Web界面、多渠道通知等

  ---
  下一步建议

  我建议按以下顺序进行开发：

  Phase 1 - MVP (最小可行产品)
  1. 实现日志监控器
  2. 实现基础错误检测器（支持Python错误）
  3. 实现Claude客户端和邮件发送器
  4. 完成主流程集成

  Phase 2 - 完善功能
  1. 添加更多语言错误模式
  2. 实现去重和队列机制
  3. 完善错误处理和日志

  Phase 3 - 增强特性
  1. Web管理界面
  2. 历史记录查询
  3. 性能优化和分布式部署

  ---
  你想先从哪个模块开始实现？ 我可以帮你：
  1. 直接开始编写代码（建议先从LogMonitor或ErrorDetector开始）
  2. 先创建项目结构和配置文件
  3. 实现某个特定模块的详细代码